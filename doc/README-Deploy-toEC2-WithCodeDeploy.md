# aws code deploy
AWS CodeDeploy 是一种用于自动化应用部署的服务，支持将代码部署到不同的计算平台，包括 EC2 实例、Lambda 函数、ECS 容器服务，甚至是本地服务器。CodeDeploy 的设计目的是帮助用户减少停机时间、提高部署的可重复性，并支持版本管理和回滚。以下是 CodeDeploy 的详细介绍，包括其架构、核心概念、部署策略以及最佳实践。

### 一、CodeDeploy 架构和核心概念
CodeDeploy 的架构主要包括以下组件：

1. **应用程序**：
    - CodeDeploy 中的应用程序是指要部署的逻辑单元。一个应用程序可能包含多个版本或组件。

2. **部署组（Deployment Group）**：
    - 部署组是指定应用程序的部署目标。部署组包含一组配置，例如目标实例（EC2 或者 ECS 集群）、负载均衡器、Auto Scaling 组等。每个部署组可以使用不同的部署策略和生命周期挂钩。

3. **部署配置（Deployment Configuration）**：
    - 部署配置定义了如何将更新推送到实例的策略。AWS 提供了默认配置（如全量部署、渐进式部署等），用户也可以自定义配置。

4. **AppSpec 文件**：
    - `appspec.yml` 或 `appspec.yaml` 是 CodeDeploy 部署的核心文件，定义了代码的位置、文件的复制方式以及每个部署生命周期阶段执行的操作。

5. **生命周期挂钩（Lifecycle Hooks）**：
    - CodeDeploy 允许在部署过程中的多个阶段运行脚本，以便执行自定义任务，例如在安装之前备份数据或在部署完成后执行健康检查。

### 二、支持的计算平台
CodeDeploy 支持的计算平台包括：

1. **Amazon EC2 和 On-Premises 服务器**：
    - 支持在单台或多台 EC2 实例上执行蓝/绿或滚动部署，可以选择让部署分阶段执行，确保最小的服务影响。

2. **AWS Lambda**：
    - 支持将 Lambda 函数版本或别名更新为新版本的蓝/绿部署，帮助在无服务器架构中实现版本控制。

3. **Amazon ECS（蓝/绿部署）**：
    - 支持在 ECS 集群中使用蓝/绿部署模式，使您能够将流量从旧版本容器切换到新版本容器，以便实现无缝升级。

### 三、部署方式和策略
CodeDeploy 提供了几种主要的部署策略，以适应不同的业务需求：

1. **滚动部署（In-Place Deployment）**：
    - 滚动部署会将更新直接应用到现有的实例上。更新时，服务会逐个实例被替换为新版本。
    - 缺点是存在停机风险，适用于短时间内可以完成的更新。

2. **蓝/绿部署（Blue/Green Deployment）**：
    - 在蓝/绿部署中，CodeDeploy 会创建一组新的替代实例（“绿”环境）并将更新推送到该组。更新成功后流量会切换到绿环境，蓝环境则会作为备份。
    - 适用于需要在不影响当前版本的情况下完成测试、回滚的场景。

3. **半量部署和自定义百分比**：
    - 可以选择逐步将更新推送到特定比例的实例上（例如 50% 或 25%），确保更新逐步推广，适用于服务可用性敏感的业务。

### 四、AppSpec 文件（appspec.yml）
`appspec.yml` 文件定义了 CodeDeploy 如何处理文件复制、环境配置、服务启动等具体操作。

#### 文件结构
以下是典型的 `appspec.yml` 文件结构：

```yaml
version: 0.0
os: linux
files:
  - source: /
    destination: /var/www/html
hooks:
  BeforeInstall:
    - location: scripts/before_install.sh
      timeout: 300
      runas: root
  ApplicationStart:
    - location: scripts/start_server.sh
      timeout: 300
      runas: root
  ValidateService:
    - location: scripts/validate_service.sh
      timeout: 300
      runas: root
```

#### 关键字段
- **version**：指定文件版本。
- **os**：操作系统（支持 Linux 和 Windows）。
- **files**：定义应用程序文件的源目录和目标目录。
- **hooks**：配置生命周期挂钩，包括常见的生命周期事件：

    - **BeforeInstall**：在安装新版本之前执行，适合备份或停止服务的操作。
    - **AfterInstall**：新版本文件安装完成后执行，可以用于权限配置。
    - **ApplicationStart**：开始应用程序服务的生命周期事件。
    - **ValidateService**：验证新版本的服务运行情况。

### 五、生命周期事件（Lifecycle Events）
CodeDeploy 提供以下生命周期事件，帮助在部署过程中执行自定义操作：

1. **BeforeBlockTraffic** 和 **AfterBlockTraffic**（仅用于蓝/绿部署）：
    - 这些事件在更新流量路由之前执行，用于准备更新环境。

2. **BeforeInstall** 和 **AfterInstall**：
    - 可在这两个阶段运行脚本以进行备份、设置权限等。

3. **ApplicationStop**、**ApplicationStart** 和 **ValidateService**：
    - 控制应用的启动和停止，可以用于健康检查和启动服务。

### 六、部署流程
CodeDeploy 的部署流程通常包含以下步骤：

1. **创建和配置应用程序及部署组**：包括设置负载均衡器和目标实例。
2. **上传代码和 `appspec.yml` 文件到 S3 或其他存储**：CodeDeploy 从 S3 或 GitHub 中获取应用程序的修订版本。
3. **创建部署**：启动部署并选择要更新的版本和部署配置。
4. **监控和管理部署**：CodeDeploy 提供详细的控制台和 CloudWatch Logs 日志，帮助跟踪部署状态。
5. **回滚（如果需要）**：如果部署失败，可以选择回滚到上一个稳定版本。

### 七、蓝/绿部署的详细流程
蓝/绿部署在不影响现有版本的情况下逐步引入更新：

1. **设置负载均衡器**：蓝/绿部署通常需要使用负载均衡器来平衡蓝、绿两组实例。
2. **创建绿环境实例**：CodeDeploy 创建一个替代版本的实例，并将新版本推送到绿环境中。
3. **切换流量**：当绿环境验证通过后，流量会从蓝环境切换到绿环境。
4. **旧环境可选清理或保留**：完成切换后，蓝环境实例可以保留以便回滚或被销毁。

### 八、最佳实践
1. **使用负载均衡器和 Auto Scaling**：
    - 蓝/绿部署中应使用负载均衡器，确保流量自动路由到更新后的实例。同时使用 Auto Scaling 来确保实例自动扩展。

2. **自动化部署和 CI/CD 集成**：
    - 使用 CodePipeline 集成 CodeDeploy，实现自动化持续交付，尤其适用于频繁更新的应用。

3. **配置 CloudWatch Logs**：
    - 使用 CloudWatch Logs 监控部署过程中的输出，有助于调试和优化脚本。

4. **测试和回滚策略**：
    - 充分测试每个部署阶段的脚本，配置蓝/绿部署，以便在更新出错时能够快速回滚。

5. **应用健康检查**：
    - 在生命周期钩子（如 ValidateService）中添加健康检查，确保新版本稳定运行。

### 九、常见问题
1. **部署失败的处理**：
    - 确保 `appspec.yml` 配置正确，检查生命周期钩子脚本，并查看 CloudWatch Logs 获取详细日志。

2. **如何在部署失败时自动回滚**：
    - CodeDeploy 支持自动回滚功能，失败时会自动切换回到上一个版本。

3. **蓝/绿部署流量配置**：
    - 可以自定义流量切换百分比和切换时间，确保流量平稳迁移。

总之，AWS CodeDeploy 是一个灵活且功能丰富的部署工具，适合需要持续交付和频繁部署的项目。

## code deploy 的好处

使用 AWS CodeDeploy 有很多好处，特别是对于希望实现高效、自动化、零停机部署的开发团队和运维团队。以下是使用 CodeDeploy 的主要优势：

### 1. **自动化和可重复性**
- CodeDeploy 能够自动化整个部署流程，减少了人工操作带来的错误风险。
- 通过定义的 `appspec.yml` 文件和生命周期挂钩，确保部署过程具有可重复性和一致性。

### 2. **支持蓝/绿部署**
- CodeDeploy 支持蓝/绿部署，帮助用户在不影响现有环境的情况下测试新版本。
- 通过负载均衡器，CodeDeploy 可以将流量从旧环境平滑地切换到新环境，减少停机时间并支持快速回滚。

### 3. **支持多种计算平台**
- CodeDeploy 不仅支持在 Amazon EC2 实例和 ECS 容器上部署应用，还支持 Lambda 和本地服务器，适应性更强。
- 可以在同一个工具内管理不同计算平台的部署，简化运维流程。

### 4. **灵活的部署策略**
- CodeDeploy 提供多种部署策略，例如滚动部署（In-Place）、蓝/绿部署、分阶段部署等，满足不同的业务需求。
- 用户可以选择一次性部署到所有实例或逐步部署，从而保证业务的连续性。

### 5. **无缝的 CI/CD 集成**
- CodeDeploy 可以与 AWS CodePipeline 轻松集成，构建端到端的 CI/CD 流程，自动化从代码提交到生产环境的部署过程。
- 还能与 Jenkins 等第三方 CI/CD 工具集成，支持灵活的 DevOps 流程。

### 6. **生命周期挂钩和自定义脚本**
- CodeDeploy 支持部署过程中多个阶段的生命周期挂钩，可以在 `BeforeInstall`、`AfterInstall`、`ApplicationStart` 等阶段执行自定义脚本，方便实现各种自定义部署操作。
- 例如，在安装新版本之前，可以执行数据备份或停止服务，确保在安装之后一切恢复正常。

### 7. **快速回滚**
- 如果部署失败，CodeDeploy 可以自动回滚到上一个稳定版本，避免长时间的服务中断。
- 回滚功能尤其适用于蓝/绿部署，可以立即将流量切换回旧环境，确保业务不受影响。

### 8. **高度可见性和监控**
- CodeDeploy 与 Amazon CloudWatch 集成，提供详细的部署日志和监控信息，帮助快速识别和解决问题。
- 支持在控制台查看每个实例的部署状态和详细日志，便于调试和性能优化。

### 9. **跨平台一致性**
- CodeDeploy 提供一致的部署方式，无论是 EC2 实例、ECS 容器、Lambda 函数还是本地服务器，都可以使用同样的配置文件和流程进行部署。
- 对于使用多种计算平台的企业，CodeDeploy 可以显著简化多平台的运维工作。

### 10. **减少停机时间**
- 通过蓝/绿部署和分阶段部署，CodeDeploy 能够有效减少或避免停机时间，让用户在更新过程中无感知。
- 部署时还可以配置负载均衡器，将流量导向健康的实例，提升服务的可用性和稳定性。

### 11. **适应复杂的部署需求**
- CodeDeploy 适用于各种应用场景和架构，无论是单实例、小型应用，还是分布式、微服务架构的复杂应用都可以使用。
- 通过自定义部署配置和脚本，可以满足高度定制化的部署需求。

### 12. **经济实惠**
- CodeDeploy 作为 AWS 的托管服务，具备按需收费的特点。对小规模的应用程序部署免费使用，对于大规模的部署场景按使用量计费，降低了维护和基础设施的成本。
- 对于开发团队来说，省去了搭建和维护自有部署管道的麻烦。

### 适用场景总结
CodeDeploy 的自动化、灵活性和多平台支持，使其成为 DevOps 和 CI/CD 流程中的一个关键组件，适用于以下场景：
- 希望提高部署效率并减少人工干预的开发团队。
- 有频繁更新需求并希望实现零停机部署的应用程序。
- 需要在跨平台环境（EC2、ECS、Lambda、On-Premises）上进行一致部署的企业。
- 希望快速响应部署失败并实现自动回滚的生产系统。

总之，AWS CodeDeploy 提供了稳定、灵活的应用部署方式，不仅简化了运维，还显著提高了应用交付的效率和安全性。

## code deploy 的流程
![img.png](..%2Fimg%2Fimg.png)

## 创建IAM role 给ec2 部署


## Configuring an EC2 Instance for AWS CodeDeploy

## Creating a CodeDeploy Deployment Group for Tagged EC2 Instance
